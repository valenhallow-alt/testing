-- Safely destroy any previously created Rayfield UI (put this before loading the library)
if _G.RayfieldInstance then
    pcall(function()
        if type(_G.RayfieldInstance.Destroy) == "function" then
            _G.RayfieldInstance:Destroy()
        end
    end)
    _G.RayfieldInstance = nil
end

-- Load Rayfield library and create a minimal, blank window
local Rayfield = loadstring(game:HttpGet('https://raw.githubusercontent.com/UnHub-LEGO/Scripts/refs/heads/main/Rayfield%20Library'))()
_G.RayfieldInstance = Rayfield

local Window = Rayfield:CreateWindow({
    Name = "UnHub (Blank)",
    FileName = "UnHub_Blank",
    Icon = 0,
    Theme = "DarkBlue",
    ToggleUIKeybind = "H",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = nil,
        FileName = "UnHub_Blank"
    },
    Discord = {
        Enabled = false,
        Invite = "",
        RememberJoins = true
    },
    KeySystem = false,
    KeySettings = {
        Title = "UnHub",
        Subtitle = "Key",
        Note = "",
        FileName = "Key",
        SaveKey = false,
        GrabKeyFromSite = false,
        Key = {}
    }
})

-- Minimal UI toggle button (draggable) to show/hide Rayfield
do
    local ST = Instance.new("ScreenGui")
    local T = Instance.new("ImageButton")
    local Corner = Instance.new("UICorner")

    ST.Name = "Toggle UnHub"
    -- Parent to the same UI context Rayfield uses so it appears alongside the Rayfield UI
    -- If Rayfield:GetParent() or its parent is nil, fall back to CoreGui
    local parentGui = nil
    pcall(function()
        parentGui = Rayfield:GetParent() and Rayfield:GetParent().Parent
    end)
    if not parentGui or not parentGui:IsA("Instance") then
        parentGui = game:GetService("CoreGui")
    end
    ST.Parent = parentGui
    ST.ResetOnSpawn = false

    T.Name = "UnHubToggle"
    T.Parent = ST
    T.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    T.Position = UDim2.new(0, 30, 0.08, 0)
    T.Size = UDim2.new(0, 50, 0, 50)
    T.Image = "rbxassetid://112045743772867" -- replace with your decal id if desired
    T.Active = true
    T.Draggable = true
    T.AutoButtonColor = true

    Corner.Name = "Corner"
    Corner.Parent = T
    Corner.CornerRadius = UDim.new(0, 8)

    -- Toggle Rayfield visibility on click
    T.MouseButton1Click:Connect(function()
        local ok, enabled = pcall(function() return Rayfield:GetEnable() end)
        if ok then
            pcall(function() Rayfield:SetEnable(not enabled) end)
        end
    end)
end

-- === Added: Main tab with Auto Buy Egg toggle ===
do
    -- Create "Main" tab (use an icon id or 0 for none)
    local MainTab = Window:CreateTab("Main", 4483362458)
    local MainSection = MainTab:CreateSection("Main")

    -- Global flag used by the toggle loop
    _G.UnHub_AutoBuyEgg = _G.UnHub_AutoBuyEgg or false

    -- Helper: safe proximity prompt fire (works in many exploit environments)
    local function tryFireProximityPrompt(prompt)
        local ok, err = pcall(function()
            if typeof(fireproximityprompt) == "function" then
                fireproximityprompt(prompt)
            elseif prompt:IsA("ProximityPrompt") and prompt.Parent and prompt.Parent:FindFirstChildOfClass("ClickDetector") then
                -- fallback attempt: click detector (not guaranteed)
                local cd = prompt.Parent:FindFirstChildOfClass("ClickDetector")
                if cd and typeof(cd.MouseClick) == "RBXScriptSignal" then
                    cd:FireAllClients()
                end
            end
        end)
        return ok
    end

    -- Create the Auto Buy Egg toggle
    local AutoBuyToggle = MainTab:CreateToggle({
        Name = "Auto Buy Egg",
        CurrentValue = false,
        Flag = "AutoBuyEgg",
        Callback = function(Value)
            _G.UnHub_AutoBuyEgg = Value

            if Value then
                -- Start a loop that attempts to buy eggs while enabled
                spawn(function()
                    while _G.UnHub_AutoBuyEgg do
                        pcall(function()
                            -- Example strategies (attempt common remote names, then proximity prompts)
                            local success = false

                            -- 1) Try common RemoteEvent/RemoteFunction names in ReplicatedStorage
                            local rs = game:GetService("ReplicatedStorage")
                            if rs then
                                local candidates = {"BuyEgg", "PurchaseEgg", "EggShop", "BuyItem", "PurchaseItem"}
                                for _, name in ipairs(candidates) do
                                    local rem = rs:FindFirstChild(name)
                                    if rem and rem:IsA("RemoteEvent") then
                                        pcall(function() rem:FireServer() end)
                                        success = true
                                        break
                                    elseif rem and rem:IsA("RemoteFunction") then
                                        pcall(function() rem:InvokeServer() end)
                                        success = true
                                        break
                                    end
                                end
                            end

                            -- 2) Try workspace ProximityPrompts that mention "egg" or "shop"
                            if not success then
                                for _, obj in ipairs(workspace:GetDescendants()) do
                                    if obj:IsA("ProximityPrompt") then
                                        local name = (obj.Name or ""):lower()
                                        local parentName = (obj.Parent and obj.Parent.Name or ""):lower()
                                        if name:find("egg") or parentName:find("egg") or name:find("shop") or parentName:find("shop") then
                                            tryFireProximityPrompt(obj)
                                            success = true
                                            break
                                        end
                                    end
                                end
                            end

                            -- 3) Try to find a ClickDetector with "egg" in parent name
                            if not success then
                                for _, obj in ipairs(workspace:GetDescendants()) do
                                    if obj:IsA("ClickDetector") then
                                        local pname = (obj.Parent and obj.Parent.Name or ""):lower()
                                        if pname:find("egg") or pname:find("shop") then
                                            pcall(function() obj:FireAllClients() end)
                                            success = true
                                            break
                                        end
                                    end
                                end
                            end
                        end)

                        -- Wait a short interval before trying again
                        wait(1)
                    end
                end)
            end
        end,
    })
end
-- === End added Main tab ===

-- Load (or create) configuration so Rayfield can restore UI state if needed
pcall(function() Rayfield:LoadConfiguration() end)

