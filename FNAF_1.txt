-- Safely destroy any previously created Rayfield UI (put this before loading the library)
if _G.RayfieldInstance then
    pcall(function()
        if type(_G.RayfieldInstance.Destroy) == "function" then
            _G.RayfieldInstance:Destroy()
        end
    end)
    _G.RayfieldInstance = nil
end

-- UnHub | by LE_GO89 (updated: robust toggle start/stop behavior)
local Rayfield = loadstring(game:HttpGet('https://raw.githubusercontent.com/UnHub-LEGO/Scripts/refs/heads/main/Rayfield%20Library'))()
_G.RayfieldInstance = Rayfield

local Window = Rayfield:CreateWindow({
   Name = "UnHub | by LE_GO89",
   FileName = "UnHub",
   Icon = 0,
   LoadingTitle = "UnHub",
   LoadingSubtitle = "by LE_GO89",
   Theme = "DarkBlue",
   ToggleUIKeybind = "H",
   ConfigurationSaving = {
      Enabled = true,
      FolderName = nil,
      FileName = "UnHub"
   },
   Discord = {
      Enabled = false,
      Invite = "",
      RememberJoins = true
   },
   KeySystem = false,
   KeySettings = {
      Title = "UnHub",
      Subtitle = "Key",
      Note = "Get the key by visit the website and wait 5 sec copy the key",
      FileName = "Key",
      SaveKey = false,
      GrabKeyFromSite = false,
      Key = {"Hi"}
    }
})

local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local plr = game.Players.LocalPlayer
local Players = game.Players
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Feature toggles / state
local AutoBuyTadpoles = false
local AutoPickUp = false
local AutoBuyGears = false
local BuyLoungeItems = false
local PlaceAllTadpoles = false
local AutoSell = false
local IgnorePickupFor = {} -- table of selected names to ignore

-- Controller tokens to safely start/stop background tasks
local controllers = {
    AutoBuyTadpoles = {token = 0},
    AutoPickUp = {token = 0},
    AutoBuyGears = {token = 0},
    BuyLoungeItems = {token = 0},
    PlaceAllTadpoles = {token = 0},
    AutoSell = {token = 0}
}

-- Anti-AFK: always enabled (no toggle in UI)
do
    local vu = game:GetService("VirtualUser")
    RunAntiAfk = game:GetService("Players").LocalPlayer.Idled:Connect(function()
        vu:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
        wait(1)
        vu:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
    end)
end

local multipliers = {
    K = 1e3,
    M = 1e6,
    B = 1e9,
    T = 1e12
}

local function NumberCoverter(text)
    text = tostring(text):upper()
    local value, suffix = text:match("([%d%.]+)%s*([KMBT]?)")
    value = tonumber(value)
    if not value then return nil end
    if suffix ~= "" and multipliers[suffix] then
        return value * multipliers[suffix]
    end
    return value
end

-- Tadpole shop display order (user-specified)
local TadpoleOptions = {
    "Pond Tadpole","Wood Tadpole","Dewback Tadpole","Bullfrog Tadpole","Dart Tadpole",
    "Mossback Tadpole","Frogberry Tadpole","Budtop Tadpole","Mushtoad Tadpole","Sugar Tadpole",
    "Glacier Tadpole","Molten Tadpole","Chronogear Tadpole","Voltcloud Tadpole","Crystalback Tadpole",
    "Shadow Hopper Tadpole","Astro Tadpole","Candelune Tadpole","Frogzilla Tadpole","Cheeseburger Tadpole",
    "Runesage Tadpole","Arcana Tadpole","Moltrix Tadpole","Bunblossom Tadpole","Jester Tadpole","Archangel Tadpole"
}

-- Exact frog/toad display names for ignore list (user-specified, exact order/spelling)
local FrogNames = {
    "Pond Frog","Wood Frog","Dewback Frog","Bullfrog","Dart Frog","Mossback Frog","Frogberry",
    "Budtop Frog","Mushtoad","Sugar Frog","Glacier Frog","Molten Toad","Chronogear Toad",
    "Voltcloud Toad","Crystalback Toad","Shadow Hopper","Astro Frog","Candelune Toad",
    "Frogzilla","Cheeseburger Frog","Runesage Frog","Arcana Toad","Moltrix Toad",
    "Bunblossom Frog","Jester Frog","Archangel Frog"
}

-- Build Tadpole (Frog) shop data from GUI (if available)
local Frog = {}
local FrogList = {}
local ShopFrog = {}

if plr and plr.PlayerGui and plr.PlayerGui:FindFirstChild("Tadpole Trove_Shop") then
    for i, v in pairs(plr.PlayerGui["Tadpole Trove_Shop"].MainContainer.Container.Frame.Body.Items:GetChildren()) do
        if v:IsA("Frame") and v.Name:find(" Tadpole") then
            table.insert(Frog, {v.Name, v.Name:gsub(" Tadpole", " Frog"), tonumber(NumberCoverter(v.Right.PriceSection.Button.Amount.Text))})
        end
    end
    for i, v in pairs(Frog) do
        table.insert(FrogList, v[1])
    end
end

-- Lilypad shop items (used by Buy Lounge Items)
local Lilypad = {}
local LilypadList = {}

if plr and plr.PlayerGui and plr.PlayerGui:FindFirstChild("Lilypad Lounge_Shop") then
    for i, v in pairs(plr.PlayerGui["Lilypad Lounge_Shop"].MainContainer.Container.Frame.Body.Items:GetChildren()) do
        if v:IsA("Frame") then
            table.insert(Lilypad, {v.Name, tonumber(NumberCoverter(v.Right.PriceSection.Button.Amount.Text))})
        end
    end
    for i, v in pairs(Lilypad) do
        table.insert(LilypadList, v[1])
    end
end

-- Ribbit (Gears) shop data (static order used for dropdown)
local RibbitOptions = {
    "Frog Labeler","Dripleaf Pad","Emberleaf Pad","Azureleaf Pad","Bug Spray",
    "Swamp Soother","Pondlight Orb","Frogtag Charm","Runechime Pillar","Pondmother's Phial","Asterveil Catalyst"
}
local Ribbit = {}
local RibbitList = {}
local ShopRibbit = {}
if plr and plr.PlayerGui and plr.PlayerGui:FindFirstChild("Ribbit Rack_Shop") then
    for i, v in pairs(plr.PlayerGui["Ribbit Rack_Shop"].MainContainer.Container.Frame.Body.Items:GetChildren()) do
        if v:IsA("Frame") then
            table.insert(Ribbit, {v.Name, tonumber(NumberCoverter(v.Right.PriceSection.Button.Amount.Text))})
        end
    end
    for i, v in pairs(Ribbit) do
        table.insert(RibbitList, v[1])
    end
end

-- Helper: safe invoke purchase for tadpoles
local function tryPurchaseTadpole(name, mappedName)
    pcall(function()
        ReplicatedStorage:WaitForChild("TadpoleShopComms"):WaitForChild("RF"):WaitForChild("OnPurchaseItem"):InvokeServer(name, mappedName)
    end)
end

-- Helper: safe invoke purchase for ribbit/gear
local function tryPurchaseGear(name)
    pcall(function()
        ReplicatedStorage:WaitForChild("GearShopComms"):WaitForChild("RF"):WaitForChild("OnPurchaseItem"):InvokeServer(name)
    end)
end

-- Helper: safe invoke purchase for lilypad lounge
local function tryPurchaseLounge(name)
    pcall(function()
        ReplicatedStorage:WaitForChild("LilypadLoungeComms"):WaitForChild("RF"):WaitForChild("OnPurchaseItem"):InvokeServer(name)
    end)
end

-- Queue-based pickup processor (one request at a time)
local pickupQueue = {}
local pickupProcessing = false
local PICK_DELAY = 0.25

local function enqueuePickup(part)
    if not part then return end
    table.insert(pickupQueue, part)
    if not pickupProcessing then
        pickupProcessing = true
        task.spawn(function()
            while #pickupQueue > 0 do
                local partToPick = table.remove(pickupQueue, 1)
                if partToPick and partToPick.Parent then
                    pcall(function()
                        ReplicatedStorage:WaitForChild("FrogPickupComms"):WaitForChild("RE"):WaitForChild("Pickup"):FireServer(partToPick)
                    end)
                end
                task.wait(PICK_DELAY)
            end
            pickupProcessing = false
        end)
    end
end

-- Start/stop helpers for each background task using controller tokens
local function startAutoBuyTadpoles()
    controllers.AutoBuyTadpoles.token = controllers.AutoBuyTadpoles.token + 1
    local myToken = controllers.AutoBuyTadpoles.token
    task.spawn(function()
        while AutoBuyTadpoles and controllers.AutoBuyTadpoles.token == myToken do
            -- iterate Frog table (shop data) and buy selected items
            for _, v in pairs(Frog) do
                if not AutoBuyTadpoles or controllers.AutoBuyTadpoles.token ~= myToken then break end
                if ShopFrog and table.find(ShopFrog, v[1]) and NumberCoverter(plr.leaderstats.Ribbles.Value) >= v[3] then
                    tryPurchaseTadpole(v[1], v[2])
                    task.wait(0.2)
                end
            end
            task.wait(0.6)
        end
    end)
end

local function startAutoBuyGears()
    controllers.AutoBuyGears.token = controllers.AutoBuyGears.token + 1
    local myToken = controllers.AutoBuyGears.token
    task.spawn(function()
        while AutoBuyGears and controllers.AutoBuyGears.token == myToken do
            for _, v in pairs(Ribbit) do
                if not AutoBuyGears or controllers.AutoBuyGears.token ~= myToken then break end
                if ShopRibbit and table.find(ShopRibbit, v[1]) and NumberCoverter(plr.leaderstats.Ribbles.Value) >= v[2] then
                    tryPurchaseGear(v[1])
                    task.wait(0.2)
                end
            end
            task.wait(0.6)
        end
    end)
end

local function startBuyLoungeItems()
    controllers.BuyLoungeItems.token = controllers.BuyLoungeItems.token + 1
    local myToken = controllers.BuyLoungeItems.token
    task.spawn(function()
        while BuyLoungeItems and controllers.BuyLoungeItems.token == myToken do
            local selected = {}
            for _, name in ipairs(LoungeObjects or {}) do selected[name] = true end
            for _, name in ipairs(LoungePathways or {}) do selected[name] = true end
            for _, name in ipairs(LoungeFences or {}) do selected[name] = true end
            for _, name in ipairs(LoungePlants or {}) do selected[name] = true end
            for _, name in ipairs(LoungeRocks or {}) do selected[name] = true end
            for _, name in ipairs(LoungeBuildings or {}) do selected[name] = true end
            for _, name in ipairs(LoungeArches or {}) do selected[name] = true end
            for _, name in ipairs(LoungeLighting or {}) do selected[name] = true end

            for _, item in pairs(Lilypad) do
                if not BuyLoungeItems or controllers.BuyLoungeItems.token ~= myToken then break end
                local itemName = item[1]
                local itemPrice = item[2] or 0
                if selected[itemName] and NumberCoverter(plr.leaderstats.Ribbles.Value) >= itemPrice then
                    tryPurchaseLounge(itemName)
                    task.wait(0.2)
                end
            end
            task.wait(0.8)
        end
    end)
end

local function startAutoSell()
    controllers.AutoSell.token = controllers.AutoSell.token + 1
    local myToken = controllers.AutoSell.token
    task.spawn(function()
        while AutoSell and controllers.AutoSell.token == myToken do
            pcall(function()
                ReplicatedStorage:WaitForChild("HopNSellComms"):WaitForChild("RE"):WaitForChild("SellAll"):FireServer()
            end)
            task.wait(2.0)
        end
    end)
end

local function startPlaceAllTadpoles()
    controllers.PlaceAllTadpoles.token = controllers.PlaceAllTadpoles.token + 1
    local myToken = controllers.PlaceAllTadpoles.token
    task.spawn(function()
        while PlaceAllTadpoles and controllers.PlaceAllTadpoles.token == myToken do
            local containers = {}
            if plr and plr.Backpack then
                for _, item in pairs(plr.Backpack:GetChildren()) do table.insert(containers, item) end
            end
            if plr and plr.Character then
                for _, item in pairs(plr.Character:GetChildren()) do table.insert(containers, item) end
            end

            for _, v in pairs(containers) do
                if not PlaceAllTadpoles or controllers.PlaceAllTadpoles.token ~= myToken then break end
                if v and v:FindFirstChild("TadpoleToolComms") then
                    pcall(function()
                        local args = {
                            plr.Plot.Value:WaitForChild("SwimableAreas"):WaitForChild("Pond1"):WaitForChild("PlaceArea"),
                            vector.create(0, 0, 0)
                        }
                        v:WaitForChild("TadpoleToolComms"):WaitForChild("RE"):WaitForChild("RequestPlace"):FireServer(unpack(args))
                    end)
                    task.wait(0.35)
                end
            end

            task.wait(1)
        end
    end)
end

local function startAutoPickUp()
    controllers.AutoPickUp.token = controllers.AutoPickUp.token + 1
    local myToken = controllers.AutoPickUp.token
    task.spawn(function()
        while AutoPickUp and controllers.AutoPickUp.token == myToken do
            local entities = (plr.Plot and plr.Plot.Value and plr.Plot.Value.Entities) and plr.Plot.Value.Entities:GetChildren() or {}
            for _, v in pairs(entities) do
                if not AutoPickUp or controllers.AutoPickUp.token ~= myToken then break end
                if v and v:IsA("Part") then
                    local okToPickup = true
                    local entityName = ""
                    pcall(function()
                        if v:FindFirstChild("DisplayName") and v.DisplayName:IsA("StringValue") then
                            entityName = tostring(v.DisplayName.Value)
                        elseif v:FindFirstChild("NameTag") and v.NameTag:IsA("StringValue") then
                            entityName = tostring(v.NameTag.Value)
                        else
                            entityName = tostring(v.Name or (v.Parent and v.Parent.Name) or "")
                        end
                    end)

                    local lowerEntity = string.lower(entityName or "")
                    for _, ignoreName in ipairs(IgnorePickupFor or {}) do
                        if ignoreName and ignoreName ~= "None" and ignoreName ~= "" then
                            if string.lower(ignoreName) == lowerEntity then
                                okToPickup = false
                                break
                            end
                        end
                    end

                    if okToPickup then
                        enqueuePickup(v)
                        task.wait(0.05) -- small spacing to avoid queueing too fast
                    end
                end
            end
            task.wait(0.6)
        end
    end)
end

-- MAIN tab: includes previous Main items plus Farm items moved here
local Main = Window:CreateTab("Main", 125058207637011)
Main:CreateSection("Main")

Main:CreateToggle({
    Name = "Buy Lounge Items",
    CurrentValue = false,
    Flag = "Buy_Lounge_Items",
    Callback = function(Value)
        BuyLoungeItems = Value
        if Value then
            startBuyLoungeItems()
        else
            controllers.BuyLoungeItems.token = controllers.BuyLoungeItems.token + 1 -- cancel
        end
    end,
})

Main:CreateToggle({
    Name = "Auto Buy Tadpoles",
    CurrentValue = false,
    Flag = "Auto_Buy_Tadpoles",
    Callback = function(Value)
        AutoBuyTadpoles = Value
        if Value then
            startAutoBuyTadpoles()
        else
            controllers.AutoBuyTadpoles.token = controllers.AutoBuyTadpoles.token + 1
        end
    end,
})

Main:CreateToggle({
    Name = "Auto Buy Gears",
    CurrentValue = false,
    Flag = "Auto_Buy_Gears",
    Callback = function(Value)
        AutoBuyGears = Value
        if Value then
            startAutoBuyGears()
        else
            controllers.AutoBuyGears.token = controllers.AutoBuyGears.token + 1
        end
    end,
})

-- Farm items moved to Main

Main:CreateToggle({Name = "Auto Sell All", CurrentValue = false, Flag = "Auto_Sell_All", Callback = function(Value)
    AutoSell = Value
    if Value then
        startAutoSell()
    else
        controllers.AutoSell.token = controllers.AutoSell.token + 1
    end
end})

Main:CreateToggle({Name = "Auto Pick Up", CurrentValue = false, Flag = "Auto_Pick_Up", Callback = function(Value)
    AutoPickUp = Value
    if Value then
        startAutoPickUp()
    else
        controllers.AutoPickUp.token = controllers.AutoPickUp.token + 1
    end
end})

-- Ignore Pickup dropdown under Main (display order matches FrogNames)
local IgnoreDropdown = Main:CreateDropdown({
    Name = "Ignore Pickup for",
    Options = FrogNames,
    CurrentOption = {"None"},
    MultipleOptions = true,
    Flag = "Ignore_Pickup_For",
    Callback = function(Value)
        IgnorePickupFor = Value or {}
    end
})

-- Place All Tadpoles: toggle under Main (was in Farm)
Main:CreateToggle({
    Name = "Place All Tadpoles",
    CurrentValue = false,
    Flag = "Place_All_Tadpoles",
    Callback = function(Value)
        PlaceAllTadpoles = Value
        if Value then
            startPlaceAllTadpoles()
        else
            controllers.PlaceAllTadpoles.token = controllers.PlaceAllTadpoles.token + 1
        end
    end
})

-- SHOP tab (Lilypad dropdown removed; Tadpoles and Ribbit remain)
local Shop = Window:CreateTab("Shop", 125058207637011)
Shop:CreateSection("Shop")

-- Tadpoles Trove dropdown (display order as requested)
local Tadpoles = Shop:CreateDropdown({
    Name = "Tadpoles Trove",
    Options = TadpoleOptions,
    CurrentOption = {"None"},
    MultipleOptions = true,
    Flag = "Dropdown_Tadpoles",
    Callback = function(Value)
        ShopFrog = Value
    end
})

Shop:CreateButton({Name = "Select All Tadpoles", Callback = function()
    Tadpoles:Set(TadpoleOptions)
end})

-- Divider between Tadpole Trove and Ribbit Rack
Shop:CreateDivider()

local RibbitDrop = Shop:CreateDropdown({
    Name = "Ribbit Rack",
    Options = RibbitOptions,
    CurrentOption = {"None"},
    MultipleOptions = true,
    Flag = "Dropdown_Ribbit",
    Callback = function(Value)
        ShopRibbit = Value
    end
})

-- Rename Select All Ribbit to "Select All Gears"
Shop:CreateButton({Name = "Select All Gears", Callback = function()
    RibbitDrop:Set(RibbitOptions)
end})

-- NEW divider for the lounge buttons section
Shop:CreateDivider()

-- Move the lounge select/clear buttons into the Shop tab (new divided section)
Shop:CreateButton({Name = "Select All Lounge Items", Callback = function()
    if ddObjects then
        ddObjects:Set(ObjectsOptions)
        ddPath:Set(PathwaysOptions)
        ddFence:Set(FencesOptions)
        ddPlant:Set(PlantsOptions)
        ddRock:Set(RocksOptions)
        ddBuild:Set(BuildingsOptions)
        ddArch:Set(ArchesOptions)
        ddLight:Set(LightingOptions)
    end
end})

Shop:CreateButton({Name = "Unselect all Lounge Items", Callback = function()
    if ddObjects then
        ddObjects:Set({})
        ddPath:Set({})
        ddFence:Set({})
        ddPlant:Set({})
        ddRock:Set({})
        ddBuild:Set({})
        ddArch:Set({})
        ddLight:Set({})
    end
end})

-- LOUNGE tab and dropdowns (Lilypad items sorted into categories)
local Lounge = Window:CreateTab("Lounge", 125058207637011)
Lounge:CreateSection("Lounge")

local ObjectsOptions = {
    "Barrel","Frogbreeze Chime","Fruit Crate","Ladder","Log","Log Sapling","Log Stack","Short Log",
    "Tree Trunk","Wooden Wheelbarrow","Shelf","Small Haystack","Large Haystack","Book Stack",
    "Wooden Bench","Book","Mossy Frog Hut","Mossmuffin Abode","Mushroom Cottage","Small Duck",
    "Duck","Acornwhisk Hut","Well","Watch Tower"
}

local PathwaysOptions = {
    "Cobble Path","Mossrock Path","Plank Steps","Rockleaf Path","Softwood Path","Stone Path",
    "Wornwood Path","Log Steps","Log Path","Brick Steps","Mosscobble Path","Pebblestone Path","Blossom Path"
}

local FencesOptions = {
    "Twigweave Fence","Wooden Fence","Mossrail Fence","Sproutstick Fence","Bloomtwig Fence"
}

local PlantsOptions = {
    "Giant Lilypad","Lilypad","Mushroom","Mushroom Cluster","Short Cattails","Starpetal Ferns",
    "Cattails","Dewdrop Lilies","Faelight Petals","Lilypad Umbrella","Bellblossoms","Lotus"
}

local RocksOptions = {
    "Rock cluster","Rocks","Small Rocks","Grass Mound","Mossy Rocks"
}

local BuildingsOptions = {
    "Plank Wall [1x1]","Plank Wall [3x1]","Plank Wall Plank Wall [3x2]","Wooden Pillar",
    "Wooden Wall [1x1]","Wooden Wall [3x1]","Wooden Wall [3x2]","Wooden Window",
    "Willowplank Wall [1x1]","Willowplank Wall [3x1]","Willowplank Wall [3x2]","Charwood Pillar",
    "Charwood Wall [3x1]","Charwood Wall [1x1]","Logstack Wall [1x1]","Logstack Wall [3x1]",
    "Logstack Wall [3x2]","Splitstone Wall [3x1]","Splitstone Wall [3x1]","Splitstone Wall [1x1]"
}

local ArchesOptions = {
    "Mossy Rock Arch","Rocky Arch","Wooden Arbor","Flower Ivy Arch","Rustic Wood Arbor",
    "Mushroom Arch","Willowvine Arch"
}

local LightingOptions = {
    "Mossy Latern","Latern","Stone Latern","Wooden Lamp Post","Candle","Candle Cluster",
    "Domeglow Lantern","Whisperlight Lantern","Firefly Lantern","Glowcap Lamp Post"
}

-- Variables to hold current selections
local LoungeObjects, LoungePathways, LoungeFences, LoungePlants, LoungeRocks, LoungeBuildings, LoungeArches, LoungeLighting =
    {}, {}, {}, {}, {}, {}, {}, {}

-- Create dropdowns (multiple choice)
local ddObjects = Lounge:CreateDropdown({Name = "Objects",   Options = ObjectsOptions,   CurrentOption = {"None"}, MultipleOptions = true, Flag = "Lounge_Objects",   Callback = function(Value) LoungeObjects   = Value end})
local ddPath   = Lounge:CreateDropdown({Name = "Pathways",  Options = PathwaysOptions,  CurrentOption = {"None"}, MultipleOptions = true, Flag = "Lounge_Pathways",  Callback = function(Value) LoungePathways  = Value end})
local ddFence  = Lounge:CreateDropdown({Name = "Fences",    Options = FencesOptions,    CurrentOption = {"None"}, MultipleOptions = true, Flag = "Lounge_Fences",    Callback = function(Value) LoungeFences    = Value end})
local ddPlant  = Lounge:CreateDropdown({Name = "Plants",    Options = PlantsOptions,    CurrentOption = {"None"}, MultipleOptions = true, Flag = "Lounge_Plants",    Callback = function(Value) LoungePlants    = Value end})
local ddRock   = Lounge:CreateDropdown({Name = "Rocks",     Options = RocksOptions,     CurrentOption = {"None"}, MultipleOptions = true, Flag = "Lounge_Rocks",     Callback = function(Value) LoungeRocks     = Value end})
local ddBuild  = Lounge:CreateDropdown({Name = "Buildings", Options = BuildingsOptions, CurrentOption = {"None"}, MultipleOptions = true, Flag = "Lounge_Buildings", Callback = function(Value) LoungeBuildings = Value end})
local ddArch   = Lounge:CreateDropdown({Name = "Arches",    Options = ArchesOptions,    CurrentOption = {"None"}, MultipleOptions = true, Flag = "Lounge_Arches",    Callback = function(Value) LoungeArches    = Value end})
local ddLight  = Lounge:CreateDropdown({Name = "Lighting",  Options = LightingOptions,  CurrentOption = {"None"}, MultipleOptions = true, Flag = "Lounge_Lighting",  Callback = function(Value) LoungeLighting  = Value end})

-- Ensure IgnoreDropdown uses the exact FrogNames order (in case UI created earlier)
pcall(function()
    if IgnoreDropdown and type(IgnoreDropdown.Refresh) == "function" then
        IgnoreDropdown:Refresh(FrogNames)
    end
end)

-- Final safety: ensure controllers are cancelled when UI destroyed (so toggles stop if UI removed)
if _G.RayfieldInstance then
    pcall(function()
        local oldDestroy = _G.RayfieldInstance.Destroy
        if type(oldDestroy) == "function" then
            _G.RayfieldInstance.Destroy = function(self, ...)
                -- cancel all controllers
                for k,_ in pairs(controllers) do
                    controllers[k].token = controllers[k].token + 1
                end
                return oldDestroy(self, ...)
            end
        end
    end)
end

-- Suppress the "Cannot pick up a favorited frog." alert by removing UI elements that contain that text.
do
    local TARGET_TEXT = "Cannot pick up a favorited frog"
    local function checkAndRemove(desc)
        if not desc or not desc.Parent then return end
        local ok, isText = pcall(function()
            return desc:IsA("TextLabel") or desc:IsA("TextButton") or desc:IsA("TextBox")
        end)
        if ok and isText then
            local text = ""
            pcall(function() text = tostring(desc.Text or "") end)
            if text:find(TARGET_TEXT) then
                pcall(function()
                    local parent = desc.Parent
                    for i = 1, 4 do
                        if parent == nil then break end
                        if parent:IsA("ScreenGui") or parent:IsA("Frame") or parent:IsA("ImageLabel") then
                            parent:Destroy()
                            return
                        end
                        parent = parent.Parent
                    end
                    desc:Destroy()
                end)
            end
        end
    end

    pcall(function()
        for _, d in pairs(game:GetService("CoreGui"):GetDescendants()) do
            checkAndRemove(d)
        end
    end)

    pcall(function()
        if plr and plr:FindFirstChild("PlayerGui") then
            for _, d in pairs(plr.PlayerGui:GetDescendants()) do
                checkAndRemove(d)
            end
        end
    end)

    pcall(function()
        game:GetService("CoreGui").DescendantAdded:Connect(function(desc)
            task.defer(function()
                checkAndRemove(desc)
            end)
        end)
    end)

    pcall(function()
        if plr and plr:FindFirstChild("PlayerGui") then
            plr.PlayerGui.DescendantAdded:Connect(function(desc)
                task.defer(function()
                    checkAndRemove(desc)
                end)
            end)
        end
    end)
end
