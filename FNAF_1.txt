-- Safely destroy any previously created Rayfield UI (put this before loading the library)
if _G.RayfieldInstance then
    pcall(function()
        if type(_G.RayfieldInstance.Destroy) == "function" then
            _G.RayfieldInstance:Destroy()
        end
    end)
    _G.RayfieldInstance = nil
end

-- Load Rayfield library and create a minimal, blank window
local Rayfield = loadstring(game:HttpGet('https://raw.githubusercontent.com/UnHub-LEGO/Scripts/refs/heads/main/Rayfield%20Library'))()
_G.RayfieldInstance = Rayfield

local Window = Rayfield:CreateWindow({
    Name = "UnHub (Blank)",
    FileName = "UnHub_Blank",
    Icon = 0,
    Theme = "DarkBlue",
    ToggleUIKeybind = "H",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = nil,
        FileName = "UnHub_Blank"
    },
    Discord = {
        Enabled = false,
        Invite = "",
        RememberJoins = true
    },
    KeySystem = false,
    KeySettings = {
        Title = "UnHub",
        Subtitle = "Key",
        Note = "",
        FileName = "Key",
        SaveKey = false,
        GrabKeyFromSite = false,
        Key = {}
    }
})

-- Minimal UI toggle button (draggable) to show/hide Rayfield
do
    local ST = Instance.new("ScreenGui")
    local T = Instance.new("ImageButton")
    local Corner = Instance.new("UICorner")

    ST.Name = "Toggle UnHub"
    local parentGui = nil
    pcall(function()
        parentGui = Rayfield:GetParent() and Rayfield:GetParent().Parent
    end)
    if not parentGui or not parentGui:IsA("Instance") then
        parentGui = game:GetService("CoreGui")
    end
    ST.Parent = parentGui
    ST.ResetOnSpawn = false

    T.Name = "UnHubToggle"
    T.Parent = ST
    T.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    T.Position = UDim2.new(0, 30, 0.08, 0)
    T.Size = UDim2.new(0, 50, 0, 50)
    T.Image = "rbxassetid://112045743772867"
    T.Active = true
    T.Draggable = true
    T.AutoButtonColor = true

    Corner.Name = "Corner"
    Corner.Parent = T
    Corner.CornerRadius = UDim.new(0, 8)

    T.MouseButton1Click:Connect(function()
        local ok, enabled = pcall(function() return Rayfield:GetEnable() end)
        if ok then
            pcall(function() Rayfield:SetEnable(not enabled) end)
        end
    end)
end

-- Load (or create) configuration so Rayfield can restore UI state if needed
pcall(function() Rayfield:LoadConfiguration() end)

----------------------------------------------------------------
-- Egg Status UI
-- Creates a Status tab with live-updating paragraphs for Name, Price, Rarity, Mutation (Variety)
----------------------------------------------------------------

local StatusTab = Window:CreateTab("Egg Status", 4483362458)
local StatusSection = StatusTab:CreateSection("Egg Status")

-- Create paragraphs for each stat so we can update them dynamically
local NameParagraph = StatusTab:CreateParagraph({Title = "Name", Content = "No egg detected"})
local PriceParagraph = StatusTab:CreateParagraph({Title = "Price", Content = "N/A"})
local RarityParagraph = StatusTab:CreateParagraph({Title = "Rarity", Content = "N/A"})
local MutationParagraph = StatusTab:CreateParagraph({Title = "Mutation", Content = "N/A"})

-- Helper to safely extract text from a UI object or value object
local function extractText(obj)
    if not obj then return nil end
    local ok, result = pcall(function()
        if typeof(obj) == "Instance" then
            if obj:IsA("TextLabel") or obj:IsA("TextButton") or obj:IsA("TextBox") then
                return tostring(obj.Text)
            elseif obj:IsA("StringValue") or obj:IsA("IntValue") or obj:IsA("NumberValue") or obj:IsA("BoolValue") then
                return tostring(obj.Value)
            elseif obj:IsA("Frame") or obj:IsA("ImageLabel") or obj:IsA("ImageButton") then
                if obj.FindFirstChildWhichIsA then
                    local child = obj:FindFirstChildWhichIsA("TextLabel")
                    if child then return tostring(child.Text) end
                end
            end
        end
        return tostring(obj)
    end)
    if ok then return result end
    return nil
end

-- Find the first workspace child that contains an Eggtag (BillboardGui)
local function findEggTag()
    for _, child in pairs(workspace:GetChildren()) do
        if child and child:FindFirstChild("Eggtag") then
            local tag = child:FindFirstChild("Eggtag")
            -- fixed operator precedence: ensure both checks are grouped
            if tag and (tag:IsA and (tag:IsA("BillboardGui") or tag.ClassName == "BillboardGui")) then
                return child, tag
            end
            -- return even if not a BillboardGui, but present
            return child, tag
        end
    end
    return nil, nil
end

-- Safely read a stat from the Eggtag.Container
local function readStat(container, name)
    if not container then return nil end
    -- direct child
    local stat = container:FindFirstChild(name)
    if stat then
        local txt = extractText(stat)
        if txt and txt ~= "" then return txt end
    end
    -- try common alternates
    local alt = container:FindFirstChild(name:lower()) or container:FindFirstChild(name:upper())
    if alt then
        local txt = extractText(alt)
        if txt and txt ~= "" then return txt end
    end
    -- search children and grandchildren for matching names or text
    for _, v in pairs(container:GetChildren()) do
        if v and v.Name and type(v.Name) == "string" then
            if v.Name:lower():find(name:lower()) then
                local txt = extractText(v)
                if txt and txt ~= "" then return txt end
            end
            for _, g in pairs(v:GetChildren()) do
                if g and g.Name and type(g.Name) == "string" and g.Name:lower():find(name:lower()) then
                    local txt = extractText(g)
                    if txt and txt ~= "" then return txt end
                end
            end
        end
    end
    return nil
end

-- Update loop
local RunService = game:GetService("RunService")
local updateInterval = 0.25 -- seconds
local accumulator = 0

RunService.Heartbeat:Connect(function(dt)
    accumulator = accumulator + dt
    if accumulator < updateInterval then return end
    accumulator = 0

    local eggModel, eggTag = findEggTag()
    if not eggModel or not eggTag then
        pcall(function()
            NameParagraph:Set({Title = "Name", Content = "No egg detected"})
            PriceParagraph:Set({Title = "Price", Content = "N/A"})
            RarityParagraph:Set({Title = "Rarity", Content = "N/A"})
            MutationParagraph:Set({Title = "Mutation", Content = "N/A"})
        end)
        return
    end

    -- Egg name is the model's name (e.g., workspace.ShinobuKocho)
    local eggName = tostring(eggModel.Name or "Unknown")

    -- Try to find Container inside the Eggtag first, then fallback to model
    local container = nil
    if eggTag and eggTag:FindFirstChild("Container") then
        container = eggTag:FindFirstChild("Container")
    else
        container = (eggModel and eggModel:FindFirstChild("Container")) or (eggTag and eggTag:FindFirstChildWhichIsA and eggTag:FindFirstChildWhichIsA("Folder")) or (eggTag and eggTag:FindFirstChildWhichIsA and eggTag:FindFirstChildWhichIsA("Frame"))
    end

    local price = readStat(container, "Price") or "Unknown"
    local rarity = readStat(container, "Rarity") or "Unknown"
    -- Use "Variety" as the mutation field (user confirmed Variety == Mutation)
    local mutation = readStat(container, "Variety") or readStat(container, "Mutation") or readStat(container, "VarietyText") or "Unknown"

    -- Update UI paragraphs
    pcall(function()
        NameParagraph:Set({Title = "Name", Content = eggName})
        PriceParagraph:Set({Title = "Price", Content = price})
        RarityParagraph:Set({Title = "Rarity", Content = rarity})
        MutationParagraph:Set({Title = "Mutation", Content = mutation})
    end)
end)

-- End of script
